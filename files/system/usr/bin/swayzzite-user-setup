#!/usr/bin/env bash
# Optional user setup script for Swayzzite
# Run this to install additional command-line tools and packages

set -oue pipefail

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

info "Starting Swayzzite optional user setup..."

# Check if running as user (not root)
if [ "$EUID" -eq 0 ]; then
    error "This script should be run as a regular user, not as root."
    exit 1
fi

# Install command-line tools
info "Installing command-line tools..."

# Claude Code CLI
if command -v claude >/dev/null 2>&1; then
    info "Claude Code CLI already installed, skipping..."
else
    info "Installing Claude Code CLI..."
    curl -fsSL https://claude.ai/install.sh | bash 2>/dev/null || warn "Failed to install Claude Code CLI"
fi

# OpenCode CLI
if command -v opencode >/dev/null 2>&1; then
    info "OpenCode CLI already installed, skipping..."
else
    info "Installing OpenCode CLI..."
    curl -fsSL https://opencode.ai/install | bash 2>/dev/null || warn "Failed to install OpenCode CLI"
fi

# uv - Python package installer and project manager
if command -v uv >/dev/null 2>&1; then
    info "Updating uv..."
    pip install --user --upgrade uv 2>/dev/null || warn "Failed to update uv"
else
    info "Installing uv..."
    pip install --user uv 2>/dev/null || warn "Failed to install uv"
fi

# aider-ce - AI pair programming tool
if command -v aider-ce >/dev/null 2>&1; then
    info "aider-ce already installed, skipping..."
else
    info "Installing aider-ce (as uv tool to avoid interfering with dev environment)..."
    uv tool install --native-tls --python python3.12 aider-ce 2>/dev/null || warn "Failed to install aider-ce"
fi

# Zed - High-performance code editor
if command -v zed >/dev/null 2>&1; then
    info "Zed already installed, skipping..."
else
    info "Installing Zed..."
    curl -f https://zed.dev/install.sh | sh 2>/dev/null || warn "Failed to install Zed"
fi

# zed-dark theme for Zed editor
if [ -f "$HOME/.config/zed/themes/zed-dark.json" ]; then
    info "zed-dark theme already installed, skipping..."
else
    info "Installing zed-dark theme for Zed..."
    mkdir -p "$HOME/.config/zed/themes" 2>/dev/null
    curl -fsSL https://raw.githubusercontent.com/mattermill/zed-dark/main/zed-dark.json -o "$HOME/.config/zed/themes/zed-dark.json" 2>/dev/null || warn "Failed to install zed-dark theme"
fi

# mise - Development environment manager (formerly rtx)
if command -v mise >/dev/null 2>&1; then
    info "mise already installed, skipping..."
else
    info "Installing mise (via official installer)..."
    curl -fsSL https://mise.run | sh 2>/dev/null || warn "Failed to install mise"
fi

# lazydocker - Docker terminal UI
if command -v lazydocker >/dev/null 2>&1; then
    info "lazydocker already installed, skipping..."
else
    info "Installing lazydocker..."
    curl https://raw.githubusercontent.com/jesseduffield/lazydocker/master/scripts/install_update_linux.sh | bash 2>/dev/null || warn "Failed to install lazydocker"
fi

# btop - Better process monitor
if rpm-ostree status 2>/dev/null >/dev/null; then
    info "Running on rpm-ostree system, using user-level installation..."
    if command -v btop >/dev/null 2>&1; then
        info "btop already installed, skipping..."
    else
        info "Note: btop should be installed via 'rpm-ostree install btop' (requires system rebuild)"
    fi
else
    info "Installing btop..."
    sudo dnf install -y btop 2>/dev/null || warn "Failed to install btop"
fi

# zoxide - Smarter cd command
if command -v zoxide >/dev/null 2>&1; then
    info "zoxide already installed, skipping..."
else
    info "Installing zoxide..."
    curl -fsSL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash 2>/dev/null || warn "Failed to install zoxide"
fi

# bat - Cat with wings (better cat)
if command -v bat >/dev/null 2>&1; then
    info "bat already installed, skipping..."
else
    info "Installing bat..."
    cargo install bat 2>/dev/null || warn "Failed to install bat (requires rust/cargo)"
fi

# ripgrep - Fast grep alternative
if command -v rg >/dev/null 2>&1; then
    info "ripgrep already installed, skipping..."
else
    info "Installing ripgrep..."
    cargo install ripgrep 2>/dev/null || warn "Failed to install ripgrep (requires rust/cargo)"
fi

# fd - Fast find alternative
if command -v fd >/dev/null 2>&1; then
    info "fd already installed, skipping..."
else
    info "Installing fd..."
    cargo install fd-find 2>/dev/null || warn "Failed to install fd (requires rust/cargo)"
fi

# eza - Better ls
if command -v eza >/dev/null 2>&1; then
    info "eza already installed, skipping..."
else
    info "Installing eza..."
    cargo install eza 2>/dev/null || warn "Failed to install eza (requires rust/cargo)"
fi

# lucidglyph - Font rendering tuning
if [ -d "$HOME/.local/share/lucidglyph" ]; then
    info "lucidglyph already installed, skipping..."
else
    info "Installing lucidglyph (font rendering tuning)..."
    TEMP_DIR=$(mktemp -d)
    info "Downloading latest lucidglyph release..."
    curl -fsSL https://api.github.com/repos/maximilionus/lucidglyph/releases/latest -o "$TEMP_DIR/release.json" 2>/dev/null
    if [ -f "$TEMP_DIR/release.json" ]; then
        DOWNLOAD_URL=$(grep -o '"browser_download_url": *"[^"]*' "$TEMP_DIR/release.json" | grep 'lucidglyph.*\.tar\.gz' | head -1 | cut -d'"' -f4)
        if [ -n "$DOWNLOAD_URL" ]; then
            curl -fsSL "$DOWNLOAD_URL" -o "$TEMP_DIR/lucidglyph.tar.gz" 2>/dev/null
            if [ -f "$TEMP_DIR/lucidglyph.tar.gz" ]; then
                tar -xzf "$TEMP_DIR/lucidglyph.tar.gz" -C "$TEMP_DIR" 2>/dev/null
                if [ -f "$TEMP_DIR/lucidglyph.sh" ]; then
                    bash "$TEMP_DIR/lucidglyph.sh" install --user 2>/dev/null || warn "Failed to install lucidglyph"
                    info "Note: You may need to log out and back in for lucidglyph font improvements to take effect."
                fi
            fi
        else
            warn "Failed to find lucidglyph download URL"
        fi
    else
        warn "Failed to fetch lucidglyph release information"
    fi
    rm -rf "$TEMP_DIR"
fi

info ""
info "Swayzzite user setup completed!"
info ""
info "Note: Some tools may require shell configuration. Add to your ~/.bashrc or ~/.zshrc:"
info "  eval \"\$(zoxide init bash)\"  # or zsh"
info "  alias ls=eza"
info "  alias cat=bat"
info ""
